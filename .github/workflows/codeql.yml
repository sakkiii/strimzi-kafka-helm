# CodeQL Security Analysis for Strimzi Kafka Helm Chart
# This workflow performs security analysis on Helm templates and YAML configurations
# to identify potential security vulnerabilities and misconfigurations.
#
name: "🔍 Security Analysis (CodeQL)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'templates/**'
      - 'values.yaml'
      - 'Chart.yaml'
      - '.checkov.yaml'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'templates/**'
      - 'values.yaml'
      - 'Chart.yaml'
      - '.checkov.yaml'
      - '.github/workflows/**'
  schedule:
    - cron: '35 21 * * 3'  # Weekly security scan

jobs:
  # Security analysis for Helm templates and YAML configurations
  security-analysis:
    name: 🔍 Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: 🛠️ Set up Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
        with:
          version: '3.14.0'

      - name: 🔍 Render Helm Templates
        run: |
          echo "🔍 Rendering Helm templates for security analysis..."
          mkdir -p rendered-templates
          
          # Add Strimzi Helm repository for dependencies
          helm repo add strimzi https://strimzi.io/charts/
          helm repo update
          
          # Update dependencies
          helm dependency update
          
          # Render with default values
          echo "Rendering templates with default values..."
          helm template security-scan . > rendered-templates/manifests-default.yaml
          
          # Test with rack awareness enabled
          echo "Rendering templates with rack awareness enabled..."
          helm template security-scan . --set kafkaCluster.rack.enabled=true > rendered-templates/manifests-rack-enabled.yaml
          
          # Test with different node selector configurations
          echo "Rendering templates with node selector..."
          helm template security-scan . --set global.nodeSelector.node-type=kafka > rendered-templates/manifests-node-selector.yaml

      - name: 🔒 Security Scan with Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: kubernetes,helm
          output_format: sarif
          output_file_path: checkov-results.sarif
          config_file: .checkov.yaml
        continue-on-error: true

      - name: 📤 Upload Checkov Results
        if: always() && hashFiles('checkov-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@883d8588e56d1753a8a58c1c86e88976f0c23449 # v3.26.8
        with:
          sarif_file: checkov-results.sarif
          category: "checkov"
        continue-on-error: true
        
      - name: 📋 Display Checkov Results Summary
        if: always()
        run: |
          if [ -f "checkov-results.sarif" ]; then
            echo "✅ Checkov scan completed. Results file exists."
            echo "📊 File size: $(ls -lh checkov-results.sarif | awk '{print $5}')"
          else
            echo "⚠️ Checkov results file not found. This might be expected if no issues were found."
          fi

  # CodeQL analysis for GitHub Actions workflows
  codeql-analysis:
    name: 🔍 CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: 'actions'
            build-mode: 'none'
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: 🔍 Initialize CodeQL
        uses: github/codeql-action/init@883d8588e56d1753a8a58c1c86e88976f0c23449 # v3.26.8
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: security-extended,security-and-quality

      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@883d8588e56d1753a8a58c1c86e88976f0c23449 # v3.26.8
        with:
          category: "/language:${{ matrix.language }}"
