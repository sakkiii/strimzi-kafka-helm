# CodeQL Security Analysis for Strimzi Kafka Helm Chart
# This workflow performs security analysis on Helm templates and YAML configurations
# to identify potential security vulnerabilities and misconfigurations.
#
name: "🔍 Security Analysis (CodeQL)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'templates/**'
      - 'values*.yaml'
      - 'Chart.yaml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'templates/**'
      - 'values*.yaml'
      - 'Chart.yaml'
  schedule:
    - cron: '35 21 * * 3'  # Weekly security scan

jobs:
  # Security analysis for Helm templates and YAML configurations
  security-analysis:
    name: 🔍 Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🛠️ Set up Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: '3.14.0'

      - name: 🔍 Render Helm Templates
        run: |
          echo "🔍 Rendering Helm templates for security analysis..."
          mkdir -p rendered-templates
          
          # Render templates with different environment configurations
          for values_file in values*.yaml; do
            if [ -f "$values_file" ]; then
              env_name=$(basename "$values_file" .yaml | sed 's/values-//')
              echo "Rendering templates with $values_file"
              helm template security-scan . -f "$values_file" > "rendered-templates/manifests-$env_name.yaml"
            fi
          done
          
          # Render with default values
          helm template security-scan . > rendered-templates/manifests-default.yaml

      - name: 🔒 Security Scan with Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes,helm
          output_format: sarif
          output_file_path: checkov-results.sarif
          config_file: .checkov.yaml
        continue-on-error: true

      - name: 📤 Upload Checkov Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
          category: "checkov"
        continue-on-error: true

  # CodeQL analysis for GitHub Actions workflows
  codeql-analysis:
    name: 🔍 CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: 'actions'
            build-mode: 'none'
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔍 Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: security-extended,security-and-quality

      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
